# å¾®ä¿¡æ”¯ä»˜è¶…è¿‡2000å…ƒé…ç½®

## ğŸ“” åƒå¯»ç®€ç¬”è®°ä»‹ç»

åƒå¯»ç®€æ–‡åº“å·²å¼€æºï¼ŒGiteeä¸GitHubæœç´¢`chihiro-doc`ï¼ŒåŒ…å«ç¬”è®°æºæ–‡ä»¶`.md`ï¼Œä»¥åŠPDFç‰ˆæœ¬æ–¹ä¾¿é˜…è¯»ï¼Œæ–‡åº“é‡‡ç”¨ç²¾ç¾ä¸»é¢˜ï¼Œé˜…è¯»ä½“éªŒæ›´ä½³ï¼Œå¦‚æœæ–‡ç« å¯¹ä½ æœ‰å¸®åŠ©è¯·å¸®æˆ‘ç‚¹ä¸€ä¸ª`Star`ï½

æ›´æ–°ï¼š`æ”¯æŒåœ¨çº¿é˜…è¯»æ–‡ç« ï¼Œæ ¹æ®å‘å¸ƒæ—¥æœŸåˆ†ç±»ã€‚`

@[toc]



## ç®€ä»‹

å¾®ä¿¡è½¬è´¦å¤§äºç­‰äº2000å…ƒéœ€è¦æºå¸¦æ”¶æ¬¾äººçš„å§“åï¼Œå»ºè®®å¤§å®¶ä½¿ç”¨å®˜æ–¹ç¤ºä¾‹ä¸­çš„æ–¹æ³•è¿›è¡Œè½¬è´¦ï¼Œç”±äºæˆ‘çš„é¡¹ç›®æ¯”è¾ƒè€ï¼Œå±äºäºŒå¼€æ‰€ä»¥æˆ‘é‡æ–°å†™äº†ä¸€ä¸ªå·¥å…·ç±»ï¼Œç”¨äºè·å–å¹³å°è¯ä¹¦ï¼Œå¤§å®¶æ ¹æ®è‡ªå·±çš„éœ€æ±‚å»åšå‚è€ƒï¼Œ`æ–‡ç« ä»…åšå‚è€ƒï¼Œä¸æ‰¿æ‹…ä»»ä½•è´£ä»»ã€‚`å¦‚æœ‰ç–‘é—®è¯·ç•™è¨€è®¨è®ºï¼Œæ–‡ç« æœ‰è¯¯æ¬¢è¿æŒ‡æ­£ï¼Œæ„Ÿè°¢æ‚¨çš„è§‚çœ‹ã€‚

### å‘èµ·å•†å®¶è½¬è´¦

æ›´æ–°æ—¶é—´ï¼š2023.06.06

å‘èµ·å•†å®¶è½¬è´¦æ¥å£ã€‚å•†æˆ·å¯ä»¥é€šè¿‡è¯¥æ¥å£åŒæ—¶å‘å¤šä¸ªç”¨æˆ·å¾®ä¿¡é›¶é’±è¿›è¡Œè½¬è´¦æ“ä½œã€‚è¯·æ±‚æ¶ˆæ¯ä¸­åº”åŒ…å«å•†å®¶æ‰¹æ¬¡å•å·ã€è½¬è´¦åç§°ã€appidã€è½¬è´¦æ€»é‡‘é¢ã€è½¬è´¦æ€»ç¬”æ•°ã€è½¬è´¦openidã€æ”¶æ¬¾ç”¨æˆ·å§“åç­‰ä¿¡æ¯ã€‚æ³¨æ„å—ç†æˆåŠŸå°†è¿”å›æ‰¹æ¬¡å•å·ï¼Œæ­¤æ—¶å¹¶ä¸ä»£è¡¨è½¬è´¦æˆåŠŸï¼Œè¯·é€šè¿‡æŸ¥å•æ¥å£æŸ¥è¯¢å•æ®çš„ä»˜æ¬¾çŠ¶æ€ã€‚

## æ¥å£è¯´æ˜

**æ”¯æŒå•†æˆ·ï¼š**ã€æ™®é€šå•†æˆ·ã€‘

**è¯·æ±‚æ–¹å¼ï¼š**ã€POSTã€‘/v3/transfer/batches

**è¯·æ±‚åŸŸåï¼š**

- ã€ä¸»åŸŸåã€‘https://api.mch.weixin.qq.com ä½¿ç”¨è¯¥åŸŸåå°†è®¿é—®å°±è¿‘çš„æ¥å…¥ç‚¹

- ã€å¤‡åŸŸåã€‘https://api2.mch.weixin.qq.com ä½¿ç”¨è¯¥åŸŸåå°†è®¿é—®å¼‚åœ°çš„æ¥å…¥ç‚¹ ï¼ŒæŒ‡å¼•[ç‚¹å‡»æŸ¥çœ‹](https://pay.weixin.qq.com/wiki/doc/apiv3/Practices/chapter1_1_4.shtml)

### æœ¬æ–‡å…³é”®è¯

`å¯¼å…¥ä¾èµ–`ã€`å¾®ä¿¡å·¥å…·ç±»`ã€`è¯·æ±‚ç¤ºä¾‹`ã€`è¶…è¿‡2000å…ƒè½¬è´¦å‚æ•°`ã€`å§“ååŠ å¯†`ã€`è¯·æ±‚å‚æ•°`ã€`å¾®ä¿¡æ”¯ä»˜å¹³å°è¯ä¹¦åºåˆ—å·`ã€`Wechatpay-Serial`

## å®˜æ–¹ç¤ºä¾‹

### 1 å¯¼å…¥ä¾èµ–

```xml
        <!--		å¾®ä¿¡æ”¯ä»˜æ‰€éœ€ä¾èµ–-->
        <dependency>
            <groupId>com.squareup.okhttp3</groupId>
            <artifactId>okhttp</artifactId>
            <version>4.9.3</version>
        </dependency>
        <dependency>
            <groupId>com.github.wechatpay-apiv3</groupId>
            <artifactId>wechatpay-java</artifactId>
            <version>0.2.10</version>
        </dependency>
        <!--		å¾®ä¿¡æ”¯ä»˜æ‰€éœ€ä¾èµ–end-->
```

### 2 è¯·æ±‚å‚æ•°

#### 2.1ã€Headerã€‘HTTPå¤´å‚æ•°

- **Authorization**å¿…å¡«string

  è¯·å‚è€ƒ [ç­¾åè®¤è¯](https://pay.wechatpay.cn/wiki/doc/apiv3/wechatpay/wechatpay4_0.shtml) ç”Ÿæˆè®¤è¯ä¿¡æ¯

- **Accept**å¿…å¡«string

  è¯·è®¾ç½®ä¸º `application/json`

- **Content-Type**å¿…å¡«string

  è¯·è®¾ç½®ä¸º `application/json`

- **Wechatpay-Serial**å¿…å¡«string

  **ã€å¾®ä¿¡æ”¯ä»˜å¹³å°è¯ä¹¦åºåˆ—å·ã€‘** è¯·æ±‚å‚æ•°ä¸­çš„æ•æ„Ÿå­—æ®µï¼Œéœ€è¦ä½¿ç”¨å¾®ä¿¡æ”¯ä»˜å¹³å°è¯ä¹¦å…¬é’¥åŠ å¯†ã€‚è¯·è®¾ç½®ä¸ºè¯¥è¯ä¹¦çš„è¯ä¹¦åºåˆ—å·ã€‚è¯¦è§[æ•æ„Ÿä¿¡æ¯åŠ è§£å¯†](https://pay.weixin.qq.com/wiki/doc/apiv3/wechatpay/wechatpay4_3.shtml)

  

#### 2.2ã€Bodyã€‘åŒ…ä½“å‚æ•°

- **appid**å¿…å¡«string(32)

  **ã€å•†æˆ·appidã€‘** ç”³è¯·å•†æˆ·å·çš„appidæˆ–å•†æˆ·å·ç»‘å®šçš„appidï¼ˆä¼ä¸šå·corpidå³ä¸ºæ­¤appidï¼‰

- **out_batch_no**å¿…å¡«string(32)

  **ã€å•†å®¶æ‰¹æ¬¡å•å·ã€‘** å•†æˆ·ç³»ç»Ÿå†…éƒ¨çš„å•†å®¶æ‰¹æ¬¡å•å·ï¼Œè¦æ±‚æ­¤å‚æ•°åªèƒ½ç”±æ•°å­—ã€å¤§å°å†™å­—æ¯ç»„æˆï¼Œåœ¨å•†æˆ·ç³»ç»Ÿå†…éƒ¨å”¯ä¸€

- **batch_name**å¿…å¡«string(32)

  **ã€æ‰¹æ¬¡åç§°ã€‘** è¯¥ç¬”æ‰¹é‡è½¬è´¦çš„åç§°

- **batch_remark**å¿…å¡«string(32)

  **ã€æ‰¹æ¬¡å¤‡æ³¨ã€‘** è½¬è´¦è¯´æ˜ï¼ŒUTF8ç¼–ç ï¼Œæœ€å¤šå…è®¸32ä¸ªå­—ç¬¦

- **total_amount**å¿…å¡«integer

  **ã€è½¬è´¦æ€»é‡‘é¢ã€‘** è½¬è´¦é‡‘é¢å•ä½ä¸ºâ€œåˆ†â€ã€‚è½¬è´¦æ€»é‡‘é¢å¿…é¡»ä¸æ‰¹æ¬¡å†…æ‰€æœ‰æ˜ç»†è½¬è´¦é‡‘é¢ä¹‹å’Œä¿æŒä¸€è‡´ï¼Œå¦åˆ™æ— æ³•å‘èµ·è½¬è´¦æ“ä½œ

- **total_num**å¿…å¡«integer

  **ã€è½¬è´¦æ€»ç¬”æ•°ã€‘** ä¸€ä¸ªè½¬è´¦æ‰¹æ¬¡å•æœ€å¤šå‘èµ·ä¸€åƒç¬”è½¬è´¦ã€‚è½¬è´¦æ€»ç¬”æ•°å¿…é¡»ä¸æ‰¹æ¬¡å†…æ‰€æœ‰æ˜ç»†ä¹‹å’Œä¿æŒä¸€è‡´ï¼Œå¦åˆ™æ— æ³•å‘èµ·è½¬è´¦æ“ä½œ

- **transfer_detail_list**å¿…å¡«array[TransferDetailInput]

  **ã€è½¬è´¦æ˜ç»†åˆ—è¡¨ã€‘** å‘èµ·æ‰¹é‡è½¬è´¦çš„æ˜ç»†åˆ—è¡¨ï¼Œæœ€å¤šä¸€åƒç¬”

  - **out_detail_no**å¿…å¡«string(32)

    **ã€å•†å®¶æ˜ç»†å•å·ã€‘** å•†æˆ·ç³»ç»Ÿå†…éƒ¨åŒºåˆ†è½¬è´¦æ‰¹æ¬¡å•ä¸‹ä¸åŒè½¬è´¦æ˜ç»†å•çš„å”¯ä¸€æ ‡è¯†ï¼Œè¦æ±‚æ­¤å‚æ•°åªèƒ½ç”±æ•°å­—ã€å¤§å°å†™å­—æ¯ç»„æˆ

  - **transfer_amount**å¿…å¡«integer

    **ã€è½¬è´¦é‡‘é¢ã€‘** è½¬è´¦é‡‘é¢å•ä½ä¸ºâ€œåˆ†â€

  - **transfer_remark**å¿…å¡«string(32)

    **ã€è½¬è´¦å¤‡æ³¨ã€‘** å•æ¡è½¬è´¦å¤‡æ³¨ï¼ˆå¾®ä¿¡ç”¨æˆ·ä¼šæ”¶åˆ°è¯¥å¤‡æ³¨ï¼‰ï¼ŒUTF8ç¼–ç ï¼Œæœ€å¤šå…è®¸32ä¸ªå­—ç¬¦

  - **openid**å¿…å¡«string(64)

    **ã€æ”¶æ¬¾ç”¨æˆ·openidã€‘** å•†æˆ·appidä¸‹ï¼ŒæŸç”¨æˆ·çš„openid

  - **user_name**é€‰å¡«string(1024)

    **ã€æ”¶æ¬¾ç”¨æˆ·å§“åã€‘** æ”¶æ¬¾æ–¹çœŸå®å§“åã€‚æ”¯æŒæ ‡å‡†RSAç®—æ³•å’Œå›½å¯†ç®—æ³•ï¼Œå…¬é’¥ç”±å¾®ä¿¡ä¾§æä¾›
    æ˜ç»†è½¬è´¦é‡‘é¢<0.3å…ƒæ—¶ï¼Œä¸å…è®¸å¡«å†™æ”¶æ¬¾ç”¨æˆ·å§“å
    æ˜ç»†è½¬è´¦é‡‘é¢ >= 2,000å…ƒæ—¶ï¼Œè¯¥ç¬”æ˜ç»†å¿…é¡»å¡«å†™æ”¶æ¬¾ç”¨æˆ·å§“å
    åŒä¸€æ‰¹æ¬¡è½¬è´¦æ˜ç»†ä¸­çš„å§“åå­—æ®µä¼ å…¥è§„åˆ™éœ€ä¿æŒä¸€è‡´ï¼Œä¹Ÿå³å…¨éƒ¨å¡«å†™ã€æˆ–å…¨éƒ¨ä¸å¡«å†™
    è‹¥å•†æˆ·ä¼ å…¥æ”¶æ¬¾ç”¨æˆ·å§“åï¼Œå¾®ä¿¡æ”¯ä»˜ä¼šæ ¡éªŒç”¨æˆ·openIDä¸å§“åæ˜¯å¦ä¸€è‡´ï¼Œå¹¶æä¾›ç”µå­å›å•

- **transfer_scene_id**é€‰å¡«string(36)

  **ã€è½¬è´¦åœºæ™¯IDã€‘** è¯¥æ‰¹æ¬¡è½¬è´¦ä½¿ç”¨çš„è½¬è´¦åœºæ™¯ï¼Œå¦‚ä¸å¡«å†™åˆ™ä½¿ç”¨å•†å®¶çš„é»˜è®¤åœºæ™¯ï¼Œå¦‚æ— é»˜è®¤åœºæ™¯å¯ä¸ºç©ºï¼Œå¯å‰å¾€â€œå•†å®¶è½¬è´¦åˆ°é›¶é’±-å‰å¾€åŠŸèƒ½â€ä¸­ç”³è¯·ã€‚
  å¦‚ï¼š1001-ç°é‡‘è¥é”€

### 3 è¯·æ±‚ç¤ºä¾‹

- `config.createEncryptor().encrypt("å¼ ä¸‰");`ï¼šæ–¹æ³•å¯ä»¥ä½¿ç”¨å¹³å°è¯ä¹¦å¸®æˆ‘ä»¬å¯¹å§“åè¿›è¡ŒåŠ å¯†

```java
package com.ruoyi.project;

import com.wechat.pay.java.core.Config;
import com.wechat.pay.java.core.RSAAutoCertificateConfig;
import com.wechat.pay.java.core.cipher.PrivacyEncryptor;
import com.wechat.pay.java.service.transferbatch.TransferBatchService;
import com.wechat.pay.java.service.transferbatch.model.InitiateBatchTransferRequest;
import com.wechat.pay.java.service.transferbatch.model.InitiateBatchTransferResponse;
import com.wechat.pay.java.service.transferbatch.model.TransferDetailInput;

import java.security.cert.X509Certificate;
import java.util.ArrayList;
import java.util.List;

public class WeChatPayTest {

    /** å•†æˆ·å· */
    public static String merchantId = "190000****";
    /** å•†æˆ·APIç§é’¥è·¯å¾„   */

    public static String privateKeyPath = "/Users/yourname/your/path/apiclient_key.pem";

    /** å•†æˆ·è¯ä¹¦åºåˆ—å· */
    public static String merchantSerialNumber = "5157F09EFDC096DE15EBE81A47057A72********";

    /** å•†æˆ·APIV3å¯†é’¥   */
    public static String apiV3Key = "...";
    public static TransferBatchService service;

    public static void main1(String[] args) {
        Config config = new RSAAutoCertificateConfig.Builder()
            .merchantId(merchantId)
            .privateKeyFromPath(privateKeyPath)
            .merchantSerialNumber(merchantSerialNumber)
            .apiV3Key(apiV3Key)
            .build();
        service = new TransferBatchService.Builder().config(config).build();

        //ã€Bodyã€‘åŒ…ä½“å‚æ•°
        InitiateBatchTransferRequest initiateBatchTransferRequest = new InitiateBatchTransferRequest();
        initiateBatchTransferRequest.setAppid("wxf636efh567hg4356");
        initiateBatchTransferRequest.setOutBatchNo("plfk2020042013");
        initiateBatchTransferRequest.setBatchName("2019å¹´1æœˆæ·±åœ³åˆ†éƒ¨æŠ¥é”€å•");
        initiateBatchTransferRequest.setBatchRemark("2019å¹´1æœˆæ·±åœ³åˆ†éƒ¨æŠ¥é”€å•");
        initiateBatchTransferRequest.setTotalAmount(4000000L);
        initiateBatchTransferRequest.setTotalNum(200);
        {
            List<TransferDetailInput> transferDetailListList = new ArrayList<>();
            {
                TransferDetailInput transferDetailInput = new TransferDetailInput();
                transferDetailInput.setOutDetailNo("x23zy545Bd5436");
                transferDetailInput.setTransferAmount(200000L);
                transferDetailInput.setTransferRemark("2020å¹´4æœˆæŠ¥é”€");
                transferDetailInput.setOpenid("o-MYE42l80oelYMDE34nYD456Xoy");
                // å®˜æ–¹ä¾‹å­ï¼š
                // transferDetailInput.setUserName("757b340b45ebef5467rter35gf464344v3542sdf4t6re4tb4f54ty45t4yyry45");
                
                // è½¬è´¦é‡‘é¢å¤§äºç­‰äºä¸¤åƒå…ƒï¼Œéœ€è¦æºå¸¦æ”¶æ¬¾ç”¨æˆ·å§“å
                if (initiateBatchTransferRequest.getTotalAmount().longValue() >= 200000){
                    /**
                     * Config config = new RSAAutoCertificateConfig.Builder()
                     * å…·æœ‰è‡ªåŠ¨ä¸‹è½½å¹¶æ›´æ–°å¹³å°è¯ä¹¦èƒ½åŠ›çš„RSAé…ç½®ç±»ã€‚ æ¯æ¬¡æ„é€ ï¼Œéƒ½ä¼šç«‹å³ä½¿ç”¨ä¼ å…¥çš„å•†æˆ·å‚æ•°ä¸‹è½½å¾®ä¿¡æ”¯ä»˜å¹³å°è¯ä¹¦ã€‚ å¦‚æœä¸‹è½½æˆåŠŸï¼ŒSDK ä¼šå°†å•†æˆ·å‚æ•°æ³¨å†Œæˆ–æ›´æ–°è‡³
                     * AutoCertificateServiceã€‚è‹¥ä¸‹è½½å¤±è´¥ï¼Œå°†ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚ ä¸ºäº†æé«˜æ€§èƒ½ï¼Œå»ºè®®å°†é…ç½®ç±»ä½œä¸ºå…¨å±€å˜é‡ï¼Œå‡å°‘ä¸å¿…è¦çš„è¯ä¹¦ä¸‹è½½ï¼Œé¿å…èµ„æºæµªè´¹
                     * ----------------------------------------------------------------
                     * æˆ‘ä»¬ç›´æ¥é€šè¿‡configè·å–åˆ°åŠ å¯†çš„æ–¹æ³•encryptor.encrypt("å¼ ä¸‰")ã€‚å¯¹å§“åè¿›è¡ŒåŠ å¯†ï¼Œ
                     * å¹³å°è¯ä¹¦åºåˆ—å·åœ¨service.initiateBatchTransfer(initiateBatchTransferRequest);ä¸­ä¼šå¸®æˆ‘ä»¬å¢åŠ ã€‚
                     * */
                    PrivacyEncryptor encryptor = config.createEncryptor();
                    transferDetailInput.setUserName(encryptor.encrypt("å¼ ä¸‰"));
                }
                
                transferDetailListList.add(transferDetailInput);
            }
            initiateBatchTransferRequest.setTransferDetailList(transferDetailListList);
        }
        initiateBatchTransferRequest.setTransferSceneId("1000");
        InitiateBatchTransferResponse response = service.initiateBatchTransfer(initiateBatchTransferRequest);
    }
}

```

### 4  åº”ç­”å‚æ•°

- > 200 OK

- **out_batch_no**å¿…å¡«string(32)

  **ã€å•†å®¶æ‰¹æ¬¡å•å·ã€‘** å•†æˆ·ç³»ç»Ÿå†…éƒ¨çš„å•†å®¶æ‰¹æ¬¡å•å·ï¼Œåœ¨å•†æˆ·ç³»ç»Ÿå†…éƒ¨å”¯ä¸€

- **batch_id**å¿…å¡«string(64)

  **ã€å¾®ä¿¡æ‰¹æ¬¡å•å·ã€‘** å¾®ä¿¡æ‰¹æ¬¡å•å·ï¼Œå¾®ä¿¡å•†å®¶è½¬è´¦ç³»ç»Ÿè¿”å›çš„å”¯ä¸€æ ‡è¯†

- **create_time**å¿…å¡«string(32)

  **ã€æ‰¹æ¬¡åˆ›å»ºæ—¶é—´ã€‘** æ‰¹æ¬¡å—ç†æˆåŠŸæ—¶è¿”å›ï¼ŒæŒ‰ç…§ä½¿ç”¨rfc3339æ‰€å®šä¹‰çš„æ ¼å¼ï¼Œæ ¼å¼ä¸ºYYYY-MM-DDThh:mm:ss+TIMEZONE

- **batch_status**é€‰å¡«string

  **ã€æ‰¹æ¬¡çŠ¶æ€ã€‘** 

  - `ACCEPTED`:å·²å—ç†ã€‚æ‰¹æ¬¡å·²å—ç†æˆåŠŸï¼Œè‹¥å‘èµ·æ‰¹é‡è½¬è´¦çš„30åˆ†é’Ÿåï¼Œè½¬è´¦æ‰¹æ¬¡å•ä»å¤„äºè¯¥çŠ¶æ€ï¼Œå¯èƒ½åŸå› æ˜¯å•†æˆ·è´¦æˆ·ä½™é¢ä¸è¶³ç­‰ã€‚å•†æˆ·å¯æŸ¥è¯¢è´¦æˆ·èµ„é‡‘æµæ°´ï¼Œè‹¥è¯¥ç¬”è½¬è´¦æ‰¹æ¬¡å•çš„æ‰£æ¬¾å·²ç»å‘ç”Ÿï¼Œåˆ™è¡¨ç¤ºæ‰¹æ¬¡å·²ç»è¿›å…¥è½¬è´¦ä¸­ï¼Œè¯·å†æ¬¡æŸ¥å•ç¡®è®¤

  - `PROCESSING`:è½¬è´¦ä¸­ã€‚å·²å¼€å§‹å¤„ç†æ‰¹æ¬¡å†…çš„è½¬è´¦æ˜ç»†å•
  - `FINISHED`:å·²å®Œæˆã€‚æ‰¹æ¬¡å†…çš„æ‰€æœ‰è½¬è´¦æ˜ç»†å•éƒ½å·²å¤„ç†å®Œæˆ
  - `CLOSED`:å·²å…³é—­ã€‚å¯æŸ¥è¯¢å…·ä½“çš„æ‰¹æ¬¡å…³é—­åŸå› ç¡®è®¤

### 5 åº”ç­”ç¤ºä¾‹

```json
{
  "out_batch_no" : "plfk2020042013",
  "batch_id" : "1030000071100999991182020050700019480001",
  "create_time" : "2015-05-20T13:29:35.120+08:00",
  "batch_status" : "ACCEPTED"
}
```

### 6 é”™è¯¯ç 

#### 6.1 å…¬å…±é”™è¯¯ç 

| çŠ¶æ€ç  | é”™è¯¯ç           | æè¿°                                   | è§£å†³æ–¹æ¡ˆ                                                     |
| :----- | :-------------- | :------------------------------------- | :----------------------------------------------------------- |
| 400    | PARAM_ERROR     | å‚æ•°é”™è¯¯                               | è¯·æ ¹æ®é”™è¯¯æç¤ºæ­£ç¡®ä¼ å…¥å‚æ•°                                   |
| 400    | INVALID_REQUEST | HTTP è¯·æ±‚ä¸ç¬¦åˆå¾®ä¿¡æ”¯ä»˜ APIv3 æ¥å£è§„åˆ™ | è¯·å‚é˜… [æ¥å£è§„åˆ™(opens new window)](https://pay.weixin.qq.com/wiki/doc/apiv3/wechatpay/wechatpay2_0.shtml) |
| 401    | SIGN_ERROR      | éªŒè¯ä¸é€šè¿‡                             | è¯·å‚é˜… [ç­¾åå¸¸è§é—®é¢˜(opens new window)](https://pay.weixin.qq.com/wiki/doc/apiv3/wechatpay/wechatpay7_1.shtml) |
| 500    | SYSTEM_ERROR    | ç³»ç»Ÿå¼‚å¸¸ï¼Œè¯·ç¨åé‡è¯•                   | è¯·ç¨åé‡è¯•                                                   |

#### 6.2 ä¸šåŠ¡é”™è¯¯ç 

| çŠ¶æ€ç  | é”™è¯¯ç                 | æè¿°                                              | è§£å†³æ–¹æ¡ˆ                                                     |
| :----- | :-------------------- | :------------------------------------------------ | :----------------------------------------------------------- |
| 400    | INVALID_REQUEST       | è¯·æ±‚å‚æ•°ç¬¦åˆå‚æ•°æ ¼å¼ï¼Œä½†ä¸ç¬¦åˆä¸šåŠ¡è§„åˆ™            | æ ¹æ®é”™è¯¯æç¤ºï¼Œä¼ å…¥æ­£ç¡®å‚æ•°                                   |
| 400    | INVALID_REQUEST       | åˆ›å»ºè®¢å•å†²çª,è¯·å‹¿å¹¶å‘è°ƒç”¨                         | æ ¹æ®é”™è¯¯æç¤ºè°ƒæ•´è°ƒç”¨ç­–ç•¥                                     |
| 400    | INVALID_REQUEST       | å¯¹åº”å•å·å·²è¶…å‡ºé‡è¯•æœŸ,è¯·æŸ¥å•ç¡®è®¤åå†³å®šæ˜¯å¦æ¢å•è¯·æ±‚ | æ ¹æ®é”™è¯¯æç¤ºè°ƒæ•´è°ƒç”¨ç­–ç•¥                                     |
| 400    | INVALID_REQUEST       | æ­¤IPåœ°å€ä¸å…è®¸è°ƒç”¨è¯¥æ¥å£                          | è¯·åœ¨å•†æˆ·å¹³å°-å•†å®¶è½¬è´¦äº§å“è¯¦æƒ…-è½¬è´¦å‘èµ·æ–¹å¼-APIå‘èµ·-æ¥å£å®‰å…¨ ä¸­é…ç½®å‘èµ·è½¬è´¦çš„IPåœ°å€ |
| 400    | INVALID_REQUEST       | APIé€šé“æœªå¼€å¯                                     | è¯·åœ¨å•†æˆ·å¹³å°-å•†å®¶è½¬è´¦äº§å“è®¾ç½®ä¸­é…ç½®APIå‘èµ·è½¬è´¦               |
| 400    | INVALID_REQUEST       | äº§å“æƒé™å¼‚å¸¸                                      | è¯·åœ¨å•†æˆ·å¹³å°-å•†å®¶è½¬è´¦äº§å“è®¾ç½®ä¸­å¼€é€šäº§å“æƒé™                  |
| 400    | INVALID_REQUEST       | è¶…å‡ºå•†æˆ·å•æ—¥è½¬è´¦é¢åº¦ï¼Œè¯·æ ¸å®äº§å“è®¾ç½®æ˜¯å¦å‡†ç¡®      | è¯·åœ¨å•†æˆ·å¹³å°-å•†å®¶è½¬è´¦äº§å“è®¾ç½®ä¸­é…ç½®è½¬è´¦æ—¥é™é¢                |
| 400    | INVALID_REQUEST       | ä½ å°šæœªè·å–è¯¥è½¬è´¦åœºæ™¯                              | è¯·åœ¨å•†æˆ·å¹³å°-å•†å®¶è½¬è´¦äº§å“è®¾ç½®ä¸­ç”³è¯·è¯¥åœºæ™¯                    |
| 400    | INVALID_REQUEST       | æœªé…ç½®æ”¶æ¬¾ç”¨æˆ·åˆ—è¡¨                                | è¯·å‰å¾€å•†æˆ·å¹³å°-å•†å®¶è½¬è´¦åˆ°é›¶é’±-è½¬è´¦åœºæ™¯ä¸­æ·»åŠ                  |
| 400    | PARAM_ERROR           | å‚æ•°é”™è¯¯                                          | æ ¹æ®é”™è¯¯æç¤ºï¼Œä¼ å…¥æ­£ç¡®å‚æ•°                                   |
| 400    | PARAM_ERROR           | å•æ‰¹æ¬¡æ˜ç»†ç¬”æ•°ä¸åˆæ³•ï¼Œæœ€é«˜æ”¯æŒ1000ç¬”æ˜ç»†ç”¨        | æ ¹æ®é”™è¯¯æç¤ºè°ƒæ•´ç­–ç•¥                                         |
| 401    | APPID_MCHID_NOT_MATCH | å•†æˆ·å·å’Œappidæ²¡æœ‰ç»‘å®šå…³ç³»                         | å•†æˆ·å·å’Œappidæ²¡æœ‰ç»‘å®šå…³ç³»                                    |
| 403    | ACCOUNTERROR          | å•†æˆ·è´¦æˆ·ä»˜æ¬¾å—é™                                  | å¯å‰å¾€å•†æˆ·å¹³å°-è¿çº¦è®°å½•è·å–è§£é™¤åŠŸèƒ½é™åˆ¶æŒ‡å¼•                  |
| 403    | NO_AUTH               | å•†æˆ·ä¿¡æ¯ä¸åˆæ³•                                    | ç™»å½•å•†æˆ·å¹³å°æ ¸å¯¹ï¼Œä¼ å…¥æ­£ç¡®ä¿¡æ¯                               |
| 403    | NOT_ENOUGH            | èµ„é‡‘ä¸è¶³                                          | å•†æˆ·è´¦æˆ·èµ„é‡‘ä¸è¶³ï¼Œè¯·å……å€¼ååŸå•é‡è¯•ï¼Œè¯·å‹¿æ›´æ¢å•†å®¶è½¬è´¦æ‰¹æ¬¡å•å· |
| 429    | FREQUENCY_LIMITED     | é¢‘ç‡è¶…é™                                          | è¯¥ç¬”è¯·æ±‚æœªå—ç†ï¼Œè¯·é™ä½é¢‘ç‡ååŸå•é‡è¯•ï¼Œè¯·å‹¿æ›´æ¢å•†å®¶è½¬è´¦æ‰¹æ¬¡å•å· |
| 500    | SYSTEM_ERROR          | ç³»ç»Ÿé”™è¯¯                                          | è¯·å‹¿æ›´æ¢å•†å®¶è½¬è´¦æ‰¹æ¬¡å•å·ï¼Œè¯·ä½¿ç”¨ç›¸åŒå‚æ•°å†æ¬¡è°ƒç”¨APIã€‚å¦åˆ™å¯èƒ½é€ æˆèµ„é‡‘æŸå¤± |



## è‡ªå®šä¹‰å·¥å…·ç±»

å¦‚æœä¸ä½¿ç”¨`wechatpay-java`ä¾èµ–ï¼ˆæ¨èä½¿ç”¨ï¼Œæ–¹ä¾¿ï¼‰ï¼Œåªæ˜¯ç”¨`wechatpay-apache-httpclient`å¯ä»¥å‚è€ƒä¸‹é¢çš„æ–¹å¼ã€‚

```xml
        <!--		å¾®ä¿¡æ”¯ä»˜æ‰€éœ€ä¾èµ–-->
        <dependency>
            <groupId>com.squareup.okhttp3</groupId>
            <artifactId>okhttp</artifactId>
            <version>4.9.3</version>
        </dependency>
		<dependency>
			<groupId>com.github.wechatpay-apiv3</groupId>
			<artifactId>wechatpay-apache-httpclient</artifactId>
			<version>0.4.8</version>
		</dependency>
        <!--		å¾®ä¿¡æ”¯ä»˜æ‰€éœ€ä¾èµ–end-->
```

#### 1 å¾®ä¿¡å·¥å…·ç±»

`WeChatPayUtils.java`

- å¸®åŠ©è·å–ç»´æŠ¤è¯ä¹¦ã€‚

```java
  /**
     * è·å–å¹³å°è¯ä¹¦
     * @param certificateSerialNo å•†æˆ·APIè¯ä¹¦åºåˆ—å·serial_no
     * @param mchId å‘èµ·è¯·æ±‚çš„å•†æˆ·ï¼ˆåŒ…æ‹¬ç›´è¿å•†æˆ·ã€æœåŠ¡å•†æˆ–æ¸ é“å•†ï¼‰çš„å•†æˆ·å·
     * @param apiV3KeyParam API v3å¯†é’¥
     * @return
     */
    public static X509Certificate getWechatpaySerial(String certificateSerialNo, String mchId, String apiV3KeyParam){
        // è®¾ç½®è¯·æ±‚å¤´
        Map<String, String> headers = new TreeMap<>();
        headers.put("Accept", "application/json");
        headers.put("User-Agent", "application/json");
        HttpUrl httpUrl = HttpUrl.parse("https://api.mch.weixin.qq.com/v3/certificates");

        LOG.info("å¼€å§‹è·å–å¹³å°è¯ä¹¦");
        try {
            String authHeader = getToken(
                "GET",
                httpUrl,
                certificateSerialNo,
                "",
                mchId
            );

            headers.put("Authorization", authHeader);
            String res = HttpUtil.createGet("https://api.mch.weixin.qq.com/v3/certificates").addHeaders(headers).execute().body();
            LOG.info("è·å–å¹³å°è¯ä¹¦è¿”å›ç»“æœ:" + res);

            // å¤„ç†è¿”å›çš„ç»“æœ
            cn.hutool.json.JSONArray data = JSONUtil.parseObj(res).getJSONArray("data");
            cn.hutool.json.JSONObject encryptCertificate = data.getJSONObject(0).getJSONObject("encrypt_certificate");
            String ciphertext = encryptCertificate.getStr("ciphertext");
            String associatedDataStr = encryptCertificate.getStr("associated_data");
            String nonceStr = encryptCertificate.getStr("nonce");

            LOG.info("================================");
            LOG.info("åŠ å¯†çš„å¹³å°è¯ä¹¦:{}", ciphertext);
            // è¿™é‡Œå¡«å†™ä½ çš„apiV3Key
            byte[] apiV3Key = apiV3KeyParam.getBytes();
            //é™„åŠ æ•°æ®åŒ…ï¼ˆå¯èƒ½ä¸ºç©ºï¼‰
            byte[] associatedData = associatedDataStr.getBytes();
            //åŠ å¯†ä½¿ç”¨çš„éšæœºä¸²åˆå§‹åŒ–å‘é‡ï¼‰
            byte[] nonce = nonceStr.getBytes();
            com.wechat.pay.contrib.apache.httpclient.util.AesUtil aesUtil = new com.wechat.pay.contrib.apache.httpclient.util.AesUtil(apiV3Key);
            String ciphertextDecrypt = aesUtil.decryptToString(associatedData, nonce, ciphertext);
            LOG.info("è§£å¯†åçš„å¹³å°è¯ä¹¦:{}", ciphertextDecrypt);

            // è·å–è¯ä¹¦å·¥å‚å®ä¾‹
            CertificateFactory certificateFactory = CertificateFactory.getInstance("X.509");

            // å°†è¯ä¹¦å­—ç¬¦ä¸²è§£æä¸ºè¯ä¹¦å¯¹è±¡
            InputStream inputStream = new ByteArrayInputStream(ciphertextDecrypt.getBytes());
            Certificate certificate = certificateFactory.generateCertificate(inputStream);

            return (X509Certificate) certificate;
        } catch (Exception e) {
            throw new ServerException("è·å–å¹³å°è¯ä¹¦å¤±è´¥:" + e);
        }
    }
```

#### 2 æºå¸¦å‚æ•°

è®¾ç½®è¯·æ±‚å¤´`Wechatpay-Serial`å’Œä½¿ç”¨å¹³å°è¯ä¹¦åŠ å¯†å§“å

```java
    public static void main(String[] args) {
        X509Certificate certificate= new WeChatPayUtils.getWechatpaySerial(certificateSerialNo, mchId, wxMerchantConfig.getWechatKey());
        // å¾®ä¿¡å¹³å°è¯ä¹¦çš„åºåˆ—å·ï¼ˆWechatpay-Serialï¼‰
        header.put("Wechatpay-Serial", certificate.getSerialNumber().toString(16));
        // æ”¶æ¬¾ç”¨æˆ·å§“åï¼Œä½¿ç”¨å¹³å°è¯ä¹¦è¿›è¡ŒåŠ å¯†
        String userName = WeChatUtils.rsaEncryptOAEP(wxTransferView.getName(), certificate);
    }
```

